const __DEFAULTFEATURENAME__="allfeatures21",__DEFAULTMARKERICON__="bus";customElements.define("leaflet-map",class extends HTMLElement{get CDN(){return this.getAttribute("cdn")||"//unpkg.com/leaflet@"+(this.getAttribute("version")||"latest")+"/dist"}get tileLayer(){return this.getAttribute("tilelayer")||"//tile.openstreetmap.org/{z}/{x}/{y}.png"}get mapdiv(){return this.shadowRoot.querySelector("div")}get markercolor(){return this.getAttribute("markercolor")||"royalblue"}get defaultMarkerIcon(){return this.L.icon({iconSize:[25,41],iconAnchor:[12,39],iconUrl:this.CDN+"/images/marker-icon.png",shadowUrl:this.CDN+"/images/marker-shadow.png"})}constructor(){super().attachShadow({mode:"open"}).innerHTML="<style>.leaflet-control-zoom{display:none}</style>"+`<link rel="stylesheet" href="${this.CDN}/leaflet.css" onload="this.getRootNode().host.mapdiv.style.opacity=1">`+'<div style="width:100%;height:100%;opacity:0"/>',this.markers=[],this.features=new Map}connectedCallback(){let t=()=>{this.L=window.L,this.render(),this.addmarkers()};window.L&&window.L.map?t():document.head.append(Object.assign(document.createElement("script"),{src:this.CDN+"/leaflet.js",onload:()=>t()}))}render(){this.shadowRoot.append(...this.querySelectorAll("[shadowRoot]")),this.map=this.L.map(this.mapdiv),this.map.addLayer(this.L.tileLayer(this.tileLayer,{})),this.map.on("click",t=>this.mapclick(t)),this.map.on("zoomstart",t=>this.mapzoomstart(t)),this.map.on("zoomend",t=>this.mapzoomend(t)),this.setView({coords:this.getAttribute("coords")})}mapclick(t){if(t.originalEvent.ctrlKey){let{lat:e,lng:r}=t.latlng,a=this.marker({lat:e,lng:r,feature:"latlng"});this.markerlabel({marker:a,lat:e,lng:r,label:`lat:${e}<br>lng:${r}`})}}mapzoomstart(t){}mapzoomend(t){}addmarkers({markers:t}={markers:this.querySelectorAll("marker")}){t.forEach(t=>{let[e,r]=this.latlng(t.getAttribute("lat")||void 0,t.getAttribute("lng")||void 0,t.getAttribute("coords")),a=e=>t.getAttribute(e)||t.parentNode.getAttribute(e);this.marker({markerNode:t,lat:e,lng:r,popup:t.innerHTML,openPopup:a("openPopup"),feature:a("feature")||__DEFAULTFEATURENAME__,icon:a("icon")||__DEFAULTMARKERICON__})}),this.fitBounds({feature:this.getAttribute("feature")||__DEFAULTFEATURENAME__})}fitBounds({feature:t,lat:e=!1,lng:r=!1,coords:a=!1}){if(t){let e=this.getFeatureGroup(t),r=e.getLayers().length;r>1?this.map.fitBounds(e.getBounds()):r?this.map.panInsideBounds(e.getBounds()):console.warn(`no fitBounds: ${t}`)}else[e,r]=this.latlng(e,r,a)}latlng(t,e,r){return"string"==typeof r&&(r=r.split(",")),r&&([t,e]=r),t&&e?[t,e]:[this.map._lastCenter.lat,this.map._lastCenter.lng]}getFeatureGroup(t){return t?this.features.get(t)||this.features.set(t,this.L.featureGroup()).get(t):this.getFeatureGroup(__DEFAULTFEATURENAME__)}feature({feature:t=__DEFAULTFEATURENAME__,node:e}){e.addTo(this.getFeatureGroup(t)),t!=__DEFAULTFEATURENAME__&&e.addTo(this.getFeatureGroup(__DEFAULTFEATURENAME__))}setView({lat:t,lng:e,coords:r=!1,zoom:a=this.getAttribute("zoom")||13}){[t,e]=this.latlng(t,e,r),this.map.setView([t,e],a)}circle({lat:t,lng:e,coords:r=!1,color:a="green",fillColor:i="lightgreen",fillOpacity:o=.5,radius:s=100}){let l=this.L.circle(this.latlng(t,e,r),{color:a,fillColor:i,fillOpacity:o,radius:s});return l.addTo(this.map),l}marker({markerNode:t,lat:e,lng:r,coords:a=!1,popup:i,openPopup:o=!1,icon:s,feature:l,label:n=t.getAttribute("label")}){[e,r]=this.latlng(e,r,a);let h=this.L.marker([e,r],{icon:this.L.divIcon({html:`<leaflet-marker-icon icon="${s}"></leaflet-marker-icon>`,className:"marker-svg",iconSize:[40,80],iconAnchor:[20,38]})});return this.markers.push(h),h.addTo(this.map),this.feature({node:h,feature:l}),this.markerlabel({marker:h,lat:e,lng:r,label:n}),i&&h.bindPopup(i,{offset:this.L.point(0,-30)}),o&&h.openPopup(),h}markerlabel({marker:t,lat:e,lng:r,label:a}){a&&("postcode"==a?fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e}&lon=${r}`).then(e=>{e.json().then(e=>{a=e.address.postcode,t.bindTooltip(a,{permanent:!0,direction:"bottom"}).addTo(this.map)})}):t.bindTooltip(a,{permanent:!0,direction:"bottom"}).addTo(this.map))}}),customElements.define("leaflet-marker-icon",class extends HTMLElement{connectedCallback(){let t=this.getAttribute("icon");if(t.includes("."))this.innerHTML=`<img style="zoom:.4" src="${t}" />`;else{let e="130;m65 0c-24 0-43 19-43 43 0 8 2 15 6 21 2 3 0 0 2 3l36 62 36-62c2-3 0 0 2-3 4-6 6-14 6-21 0-24-19-42-45-43zm0 22c12 0 22 10 22 22 0 12-10 22-22 22s-22-10-22-22c0-12 10-22 22-22z",r={bus:"110;m10 72c0 4 2 8 5 11v9c0 3 2 5 5 5h5c3 0 5-2 5-5v-5h40v5c0 3 2 5 5 5h5c3 0 5-2 5-5v-9c3-3 5-7 5-11v-50c0-18-18-20-40-20s-40 3-40 20v50zm18 5c-4 0-8-3-8-8s3-8 8-8 8 3 8 8-3 8-8 8zm45 0c-4 0-8-3-8-8s3-8 8-8 8 3 8 8-3 8-8 8zm8-30h-60v-25h60v25z",house:"170;m160 90a5 5 90 01-4-2l-72-72-72 72a5 5 90 01-7-7l75-75a5 5 90 017 0l75 75a5 5 90 01-3 9zm-76-56-60 60v61a10 10 90 0010 10h35v-50h30v50h35a10 10 90 0010-10v-61z"}[t]||e,[a,i]=r.split(";");this.innerHTML=`<svg viewBox="0 0 ${a} ${a}">`+"<style>path{fill:var(--lfm-marker,firebrick)}</style>"+`<path d="${i}"/>`+"</svg>"}}});